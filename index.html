<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image & PDF Survey</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .image-container { 
            text-align: center; 
            margin: 30px 0; 
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .image-container img { 
            max-width: 100%; 
            max-height: 400px;
            height: auto; 
            border: 3px solid #007bff; 
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .image-container iframe,
        .image-container embed {
            width: 100%;
            height: 500px;
            border: 3px solid #007bff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .pdf-fallback {
            padding: 20px;
            background: #e9ecef;
            border-radius: 8px;
            text-align: center;
        }
        
        .pdf-fallback a {
            color: #007bff;
            font-weight: bold;
        }
        
        .form-section { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 8px; 
            margin: 20px 0; 
            border-left: 5px solid #007bff;
        }
        
        .question-block {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 5px;
        }
        
        .radio-group {
            margin: 10px 0;
        }
        
        .radio-group label {
            margin-left: 8px;
            font-weight: normal;
        }
        
        .buttons { 
            display: flex; 
            gap: 15px; 
            justify-content: center; 
            margin: 30px 0; 
            flex-wrap: wrap;
        }
        
        button { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-warning { 
            background: #ffc107; 
            color: #212529;
        }
        
        .btn-primary { 
            background: #007bff; 
            color: white; 
        }
        
        .btn-success { 
            background: #28a745; 
            color: white; 
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .results { 
            margin: 20px 0; 
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 20px 0;
        }
        
        th, td { 
            border: 1px solid #ddd; 
            padding: 12px 8px; 
            text-align: left; 
        }
        
        th { 
            background: #007bff; 
            color: white;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .hidden {
            display: none;
        }
        
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .file-input {
            margin: 20px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
        }
        
        input[type="file"] {
            margin: 10px 0;
        }
        
        #image-list {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .text-input {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: Arial, sans-serif;
        }
        
        textarea.text-input {
            resize: vertical;
            min-height: 80px;
        }
        
        .input-help {
            color: #666;
            font-style: italic;
            font-size: 12px;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Image & PDF Response Survey</h1>
        
        <!-- File Upload Section -->
        <div id="setup-section">
            <div class="file-input">
                <h3>üñºÔ∏èüìÑ Load Your Images & PDFs</h3>
                <p>Select multiple images or PDF files from your computer:</p>
                <input type="file" id="image-files" multiple accept="image/*,.pdf,application/pdf">
                <button class="btn-primary" onclick="loadFiles()">Load Files</button>
                
                <div id="image-list" class="hidden">
                    <h4>Loaded Files:</h4>
                    <ul id="loaded-images-list"></ul>
                </div>
                
                <button class="btn-success hidden" id="start-survey-btn" onclick="startSurvey()">Start Survey</button>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div id="progress" class="progress-bar hidden">
            <span id="progress-text">Image 1 of 0, Response Set 1</span>
        </div>
        
        <!-- Survey Section -->
        <div id="survey-section" class="hidden">
            <div class="image-container">
                <h3 id="image-title">File 1 - Response Set 1</h3>
                <div id="file-display">
                    <img id="current-image" src="" alt="Survey Image" onerror="handleImageError()">
                </div>
            </div>
            
            <div class="form-section">
                <h4>üìù Your Response</h4>
                
                <!-- Question 1: Is there a data request? -->
                <div class="question-block">
                    <label><strong>1. Is there a data request?</strong></label><br>
                    <div class="radio-group">
                        <input type="radio" name="data_request" value="Yes" id="yes">
                        <label for="yes">Yes</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="data_request" value="No" id="no">
                        <label for="no">No</label>
                    </div>
                </div>
                
                <!-- Question 2: How many data points provided -->
                <div class="question-block">
                    <label for="data_points_provided"><strong>2. How many data points did the government provide in their answer?</strong></label><br>
                    <input type="text" id="data_points_provided" class="text-input" placeholder="Enter number or description (e.g., '5', 'multiple tables', 'see attachment')">
                    <div class="input-help">You can enter a number or describe the data provided</div>
                </div>
                
                <!-- Question 3: Granularity matching -->
                <div class="question-block">
                    <label><strong>3. Did the granularity of the variable's scope (e.g. national instead of state-level data) match between data requested and data provided?</strong></label><br>
                    <div class="radio-group">
                        <input type="radio" name="granularity_match" value="Fully matched" id="fully_matched">
                        <label for="fully_matched">Fully matched</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="granularity_match" value="More granular" id="more_granular">
                        <label for="more_granular">More granular</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="granularity_match" value="Less granular" id="less_granular">
                        <label for="less_granular">Less granular</label>
                    </div>
                </div>
                
                <!-- Question 4: Temporal unit granularity -->
                <div class="question-block">
                    <label><strong>4. Did the granularity of the variable's temporal unit (e.g. annual instead of monthly data) match between data requested and data provided?</strong></label><br>
                    <div class="radio-group">
                        <input type="radio" name="temporal_granularity" value="Fully matched" id="temporal_fully_matched">
                        <label for="temporal_fully_matched">Fully matched</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="temporal_granularity" value="More granular" id="temporal_more_granular">
                        <label for="temporal_more_granular">More granular</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="temporal_granularity" value="Less granular" id="temporal_less_granular">
                        <label for="temporal_less_granular">Less granular</label>
                    </div>
                </div>
                
                <!-- Question 5: Temporal coverage shift -->
                <div class="question-block">
                    <label><strong>5. Did the reply shift or redefine the temporal coverage of the data (e.g. provides "data since 2010" when MP asked for "2015‚Äì2018")?</strong></label><br>
                    <div class="radio-group">
                        <input type="radio" name="temporal_coverage" value="Fully matched" id="temporal_fully">
                        <label for="temporal_fully">Fully matched</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="temporal_coverage" value="Shifted earlier" id="temporal_earlier">
                        <label for="temporal_earlier">Shifted earlier</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="temporal_coverage" value="Shifted later" id="temporal_later">
                        <label for="temporal_later">Shifted later</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="temporal_coverage" value="Government did not state timeframe" id="temporal_gov_no">
                        <label for="temporal_gov_no">Government did not state timeframe</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="temporal_coverage" value="MP did not state timeframe" id="temporal_mp_no">
                        <label for="temporal_mp_no">MP did not state timeframe</label>
                    </div>
                </div>
                
                <!-- Question 6: Baseline of comparison -->
                <div class="question-block">
                    <label><strong>6. Did the government change the baseline of comparison in the data provided (e.g., providing percentage instead of absolute number, or different reference year)?</strong></label><br>
                    <div class="radio-group">
                        <input type="radio" name="baseline_shift" value="Yes, comparison shifted" id="baseline_yes">
                        <label for="baseline_yes">Yes, comparison shifted</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="baseline_shift" value="No, comparison did not shift" id="baseline_no">
                        <label for="baseline_no">No, comparison did not shift</label>
                    </div>
                </div>
                
                <!-- Question 7: More data than requested -->
                <div class="question-block">
                    <label><strong>7. Did the government provide more data than was requested?</strong></label><br>
                    <div class="radio-group">
                        <input type="radio" name="more_data" value="Yes" id="more_data_yes">
                        <label for="more_data_yes">Yes</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="more_data" value="No" id="more_data_no">
                        <label for="more_data_no">No</label>
                    </div>
                </div>
                
                <!-- Question 8: All requested variables -->
                <div class="question-block">
                    <label><strong>8. Did the government provide data for all requested variables?</strong></label><br>
                    <div class="radio-group">
                        <input type="radio" name="all_variables" value="Yes, all variables were accounted for" id="all_vars_yes">
                        <label for="all_vars_yes">Yes, all variables were accounted for</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="all_variables" value="No, data on some variables were not provided" id="all_vars_no">
                        <label for="all_vars_no">No, data on some variables were not provided</label>
                    </div>
                </div>
                
                <!-- Question 9: Variable redefined -->
                <div class="question-block">
                    <label><strong>9. In their answer, did the ministry redefine the variable or indicator requested? (e.g., MP asked for "poverty" but answer gives "low-income households")</strong></label><br>
                    <div class="radio-group">
                        <input type="radio" name="variable_redefined" value="Yes, variable definition matches" id="var_redef_yes">
                        <label for="var_redef_yes">Yes, variable definition matches</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="variable_redefined" value="No, variable definition does not match" id="var_redef_no">
                        <label for="var_redef_no">No, variable definition does not match</label>
                    </div>
                </div>
                
                <!-- Question 10: What was changed or missing -->
                <div class="question-block">
                    <label for="what_changed"><strong>10. What was changed or missing?</strong></label><br>
                    <input type="text" id="what_changed" class="text-input" placeholder="Enter description of what was changed or missing">
                </div>
                
                <!-- Question 11: All parts answered -->
                <div class="question-block">
                    <label><strong>11. Did the government answer all parts of the questions and provide data for all parts?</strong></label><br>
                    <div class="radio-group">
                        <input type="radio" name="all_parts" value="Yes, fully answered" id="all_parts_yes">
                        <label for="all_parts_yes">Yes, fully answered</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="all_parts" value="Partially answered" id="all_parts_partial">
                        <label for="all_parts_partial">Partially answered</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="all_parts" value="No, not answered at all" id="all_parts_no">
                        <label for="all_parts_no">No, not answered at all</label>
                    </div>
                </div>
                
                <!-- Question 12: Thematically answers question -->
                <div class="question-block">
                    <label><strong>12. Thematically, does the government's response answer the question?</strong></label><br>
                    <div class="radio-group">
                        <input type="radio" name="thematic_answer" value="Yes" id="thematic_yes">
                        <label for="thematic_yes">Yes</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="thematic_answer" value="No" id="thematic_no">
                        <label for="thematic_no">No</label>
                    </div>
                </div>
                
                <!-- Question 13: Justification for withholding -->
                <div class="question-block">
                    <label><strong>13. Did the government provide a justification for withholding or altering data?</strong></label><br>
                    <div class="radio-group">
                        <input type="radio" name="justification" value="No justification provided" id="just_none">
                        <label for="just_none">No justification provided</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="justification" value="Yes, citing data availability" id="just_availability">
                        <label for="just_availability">Yes, citing data availability</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="justification" value="Yes, citing confidentiality" id="just_confidentiality">
                        <label for="just_confidentiality">Yes, citing confidentiality</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="justification" value="Yes, citing irrelevance" id="just_irrelevance">
                        <label for="just_irrelevance">Yes, citing irrelevance</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="justification" value="Yes, stating that it can be found in official reports or guidelines" id="just_reports">
                        <label for="just_reports">Yes, stating that it can be found in official reports or guidelines</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="justification" value="Yes, refer to other authorities" id="just_authorities">
                        <label for="just_authorities">Yes, refer to other authorities</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="justification" value="Yes, stating that requested breakdown is not how data was collected, thus cannot provide requested breakdown" id="just_breakdown">
                        <label for="just_breakdown">Yes, stating that requested breakdown is not how data was collected, thus cannot provide requested breakdown</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="justification" value="Other justifications" id="just_other">
                        <label for="just_other">Other justifications</label>
                    </div>
                </div>
                
                <!-- Question 14: Other notes -->
                <div class="question-block">
                    <label for="other_notes"><strong>14. Any other notes or remarks on this parliamentary exchange.</strong></label><br>
                    <textarea id="other_notes" class="text-input" rows="4" placeholder="Enter any additional notes or remarks"></textarea>
                </div>
                
                <div class="buttons">
                    <button class="btn-warning" onclick="repeatImage()">üîÅ Repeat This File</button>
                    <button class="btn-primary" onclick="nextImage()">‚û°Ô∏è Next File</button>
                    <button class="btn-success" onclick="finishSurvey()">‚úÖ Finish Survey</button>
                </div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <h2>üéâ Survey Complete!</h2>
            <p>Thank you for your responses. Total responses collected: <strong id="total-responses">0</strong></p>
            
            <div class="buttons">
                <button class="btn-info" onclick="downloadResults()">üì• Download CSV</button>
                <button class="btn-warning" onclick="resetSurvey()">üîÑ Start New Survey</button>
            </div>
            
            <div id="results-table"></div> 
        </div>
        
        <!-- Alert Messages -->
        <div id="alert-container"></div>
    </div>

    <script>
        // Global variables
        let imageFiles = [];
        let imageDataUrls = [];
        let fileTypes = []; // Track whether each file is 'image' or 'pdf'
        let currentImageIndex = 0;
        let currentIteration = 1;
        let responses = [];
        let surveyStarted = false;

        // Load files (images and PDFs) from file input
        function loadFiles() {
            const fileInput = document.getElementById('image-files');
            const files = fileInput.files;
            
            if (files.length === 0) {
                showAlert('Please select at least one image or PDF file.', 'warning');
                return;
            }
            
            imageFiles = Array.from(files);
            imageDataUrls = [];
            fileTypes = [];
            
            let filesProcessed = 0;
            const imagesList = document.getElementById('loaded-images-list');
            imagesList.innerHTML = '';
            
            // Process each file
            imageFiles.forEach((file, index) => {
                const reader = new FileReader();
                const isPdf = file.type === 'application/pdf' || file.name.toLowerCase().endsWith('.pdf');
                fileTypes[index] = isPdf ? 'pdf' : 'image';
                
                reader.onload = function(e) {
                    imageDataUrls[index] = e.target.result;
                    
                    // Add to display list with file type indicator
                    const listItem = document.createElement('li');
                    const typeIcon = isPdf ? 'üìÑ' : 'üñºÔ∏è';
                    listItem.textContent = `${index + 1}. ${typeIcon} ${file.name}`;
                    imagesList.appendChild(listItem);
                    
                    filesProcessed++;
                    
                    // When all files are processed
                    if (filesProcessed === imageFiles.length) {
                        document.getElementById('image-list').classList.remove('hidden');
                        document.getElementById('start-survey-btn').classList.remove('hidden');
                        const pdfCount = fileTypes.filter(t => t === 'pdf').length;
                        const imageCount = fileTypes.filter(t => t === 'image').length;
                        showAlert(`Successfully loaded ${imageCount} image(s) and ${pdfCount} PDF(s)!`, 'success');
                    }
                };
                
                reader.onerror = function() {
                    showAlert(`Error loading ${file.name}`, 'warning');
                    filesProcessed++;
                };
                
                reader.readAsDataURL(file);
            });
        }
        
        // Alias for backwards compatibility
        function loadImages() {
            loadFiles();
        }

        // Start the survey
        function startSurvey() {
            if (imageDataUrls.length === 0) {
                showAlert('Please load files first.', 'warning');
                return;
            }
            
            surveyStarted = true;
            currentImageIndex = 0;
            currentIteration = 1;
            responses = [];
            
            // Hide setup, show survey
            document.getElementById('setup-section').classList.add('hidden');
            document.getElementById('progress').classList.remove('hidden');
            document.getElementById('survey-section').classList.remove('hidden');
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize display
            updateDisplay();
            
            showAlert('Survey started! Answer all questions and use the buttons to navigate.', 'success');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Auto-save functionality can be added here if needed
            // For now, just basic change listeners
            document.querySelectorAll('input[name="data_request"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    // Optional: Add auto-save or other functionality
                });
            });
            
            document.getElementById('data_points_provided').addEventListener('input', function() {
                // Optional: Add auto-save functionality
            });
            
            document.querySelectorAll('input[name="granularity_match"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    // Optional: Add auto-save functionality
                });
            });
        }

        // Update display
        function updateDisplay() {
            if (!surveyStarted || imageDataUrls.length === 0) return;
            
            const fileDisplayContainer = document.getElementById('file-display');
            const currentFileType = fileTypes[currentImageIndex];
            const currentFileName = imageFiles[currentImageIndex] ? imageFiles[currentImageIndex].name : `File_${currentImageIndex + 1}`;
            
            // Clear previous content
            fileDisplayContainer.innerHTML = '';
            
            if (currentFileType === 'pdf') {
                // Display PDF using embed element
                const embed = document.createElement('embed');
                embed.src = imageDataUrls[currentImageIndex];
                embed.type = 'application/pdf';
                embed.id = 'current-pdf';
                fileDisplayContainer.appendChild(embed);
                
                // Create blob URL for fallback link (works better in new tabs)
                const pdfBlobUrl = URL.createObjectURL(imageFiles[currentImageIndex]);
                
                // Add fallback link
                const fallback = document.createElement('div');
                fallback.className = 'pdf-fallback';
                fallback.innerHTML = `<p>If the PDF doesn't display, <a href="${pdfBlobUrl}" target="_blank" rel="noopener">click here to open it in a new tab</a></p>`;
                fileDisplayContainer.appendChild(fallback);
            } else {
                // Display image
                const img = document.createElement('img');
                img.src = imageDataUrls[currentImageIndex];
                img.alt = 'Survey Image';
                img.id = 'current-image';
                img.onerror = handleImageError;
                fileDisplayContainer.appendChild(img);
            }
            
            // Update titles
            const fileTypeLabel = currentFileType === 'pdf' ? 'PDF' : 'Image';
            document.getElementById('image-title').textContent = 
                `${fileTypeLabel} ${currentImageIndex + 1} - Response Set ${currentIteration}`;
            
            document.getElementById('progress-text').textContent = 
                `File ${currentImageIndex + 1} of ${imageDataUrls.length}, Response Set ${currentIteration}, Total Responses: ${responses.length}`;
        }

        // Handle image loading errors
        function handleImageError() {
            showAlert('Error loading current file. Please check the file.', 'warning');
        }

        // Get form data
        function getFormData() {
            const dataRequestRadio = document.querySelector('input[name="data_request"]:checked');
            const dataPointsProvided = document.getElementById('data_points_provided').value.trim();
            const granularityRadio = document.querySelector('input[name="granularity_match"]:checked');
            const temporalGranularityRadio = document.querySelector('input[name="temporal_granularity"]:checked');
            const temporalCoverageRadio = document.querySelector('input[name="temporal_coverage"]:checked');
            const baselineShiftRadio = document.querySelector('input[name="baseline_shift"]:checked');
            const moreDataRadio = document.querySelector('input[name="more_data"]:checked');
            const allVariablesRadio = document.querySelector('input[name="all_variables"]:checked');
            const variableRedefinedRadio = document.querySelector('input[name="variable_redefined"]:checked');
            const whatChanged = document.getElementById('what_changed').value.trim();
            const allPartsRadio = document.querySelector('input[name="all_parts"]:checked');
            const thematicAnswerRadio = document.querySelector('input[name="thematic_answer"]:checked');
            const justificationRadio = document.querySelector('input[name="justification"]:checked');
            const otherNotes = document.getElementById('other_notes').value.trim();
            
            // Validate all required fields
            if (!dataRequestRadio) {
                showAlert('Please answer whether there is a data request.', 'warning');
                return null;
            }
            
            if (!dataPointsProvided) {
                showAlert('Please specify how many data points the government provided.', 'warning');
                return null;
            }
            
            if (!granularityRadio) {
                showAlert('Please specify whether the granularity matched between request and response.', 'warning');
                return null;
            }
            
            if (!temporalGranularityRadio) {
                showAlert('Please answer question 4 about temporal unit granularity.', 'warning');
                return null;
            }
            
            if (!temporalCoverageRadio) {
                showAlert('Please answer question 5 about temporal coverage shift.', 'warning');
                return null;
            }
            
            if (!baselineShiftRadio) {
                showAlert('Please answer question 6 about baseline of comparison.', 'warning');
                return null;
            }
            
            if (!moreDataRadio) {
                showAlert('Please answer question 7 about whether more data was provided.', 'warning');
                return null;
            }
            
            if (!allVariablesRadio) {
                showAlert('Please answer question 8 about all requested variables.', 'warning');
                return null;
            }
            
            if (!variableRedefinedRadio) {
                showAlert('Please answer question 9 about variable redefinition.', 'warning');
                return null;
            }
            
            if (!allPartsRadio) {
                showAlert('Please answer question 11 about whether all parts were answered.', 'warning');
                return null;
            }
            
            if (!thematicAnswerRadio) {
                showAlert('Please answer question 12 about thematic answer.', 'warning');
                return null;
            }
            
            if (!justificationRadio) {
                showAlert('Please answer question 13 about justification for withholding data.', 'warning');
                return null;
            }
            
            return {
                imageIndex: currentImageIndex + 1,
                imageName: imageFiles[currentImageIndex] ? imageFiles[currentImageIndex].name : `File_${currentImageIndex + 1}`,
                fileType: fileTypes[currentImageIndex] || 'image',
                iteration: currentIteration,
                dataRequest: dataRequestRadio.value,
                dataPointsProvided: dataPointsProvided,
                granularityMatch: granularityRadio.value,
                temporalGranularity: temporalGranularityRadio.value,
                temporalCoverage: temporalCoverageRadio.value,
                baselineShift: baselineShiftRadio.value,
                moreData: moreDataRadio.value,
                allVariables: allVariablesRadio.value,
                variableRedefined: variableRedefinedRadio.value,
                whatChanged: whatChanged,
                allParts: allPartsRadio.value,
                thematicAnswer: thematicAnswerRadio.value,
                justification: justificationRadio.value,
                otherNotes: otherNotes,
                timestamp: new Date().toLocaleString()
            };
        }

        // Clear form
        function clearForm() {
            document.querySelectorAll('input[name="data_request"]').forEach(radio => {
                radio.checked = false;
            });
            document.getElementById('data_points_provided').value = '';
            document.querySelectorAll('input[name="granularity_match"]').forEach(radio => {
                radio.checked = false;
            });
            document.querySelectorAll('input[name="temporal_granularity"]').forEach(radio => {
                radio.checked = false;
            });
            document.querySelectorAll('input[name="temporal_coverage"]').forEach(radio => {
                radio.checked = false;
            });
            document.querySelectorAll('input[name="baseline_shift"]').forEach(radio => {
                radio.checked = false;
            });
            document.querySelectorAll('input[name="more_data"]').forEach(radio => {
                radio.checked = false;
            });
            document.querySelectorAll('input[name="all_variables"]').forEach(radio => {
                radio.checked = false;
            });
            document.querySelectorAll('input[name="variable_redefined"]').forEach(radio => {
                radio.checked = false;
            });
            document.getElementById('what_changed').value = '';
            document.querySelectorAll('input[name="all_parts"]').forEach(radio => {
                radio.checked = false;
            });
            document.querySelectorAll('input[name="thematic_answer"]').forEach(radio => {
                radio.checked = false;
            });
            document.querySelectorAll('input[name="justification"]').forEach(radio => {
                radio.checked = false;
            });
            document.getElementById('other_notes').value = '';
        }

        // Repeat current image/PDF
        function repeatImage() {
            const formData = getFormData();
            if (!formData) return;
            
            responses.push(formData);
            currentIteration++;
            clearForm();
            updateDisplay();
            showAlert('Response saved! You can provide another response for this file.', 'success');
        }

        // Move to next image
        function nextImage() {
            const formData = getFormData();
            if (!formData) return;
            
            responses.push(formData);
            currentImageIndex++;
            currentIteration = 1;
            clearForm();
            
            if (currentImageIndex >= imageDataUrls.length) {
                showResults();
            } else {
                updateDisplay();
                showAlert('Response saved! Moving to next file.', 'success');
            }
        }

        // Finish survey
        function finishSurvey() {
            const formData = getFormData();
            if (formData) {
                responses.push(formData);
            }
            showResults();
        }

        // Show results
        function showResults() {
            document.getElementById('survey-section').classList.add('hidden');
            document.getElementById('progress').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            
            document.getElementById('total-responses').textContent = responses.length;
            
            // Create results table
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>File #</th>
                            <th>File Name</th>
                            <th>File Type</th>
                            <th>Response Set</th>
                            <th>Data Request?</th>
                            <th>Data Points Provided</th>
                            <th>Granularity Match</th>
                            <th>Temporal Granularity</th>
                            <th>Temporal Coverage</th>
                            <th>Baseline Shift</th>
                            <th>More Data</th>
                            <th>All Variables</th>
                            <th>Variable Redefined</th>
                            <th>What Changed</th>
                            <th>All Parts</th>
                            <th>Thematic Answer</th>
                            <th>Justification</th>
                            <th>Other Notes</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            responses.forEach(response => {
                tableHTML += `
                    <tr>
                        <td>${response.imageIndex}</td>
                        <td>${response.imageName}</td>
                        <td>${response.fileType || 'image'}</td>
                        <td>${response.iteration}</td>
                        <td>${response.dataRequest}</td>
                        <td>${response.dataPointsProvided}</td>
                        <td>${response.granularityMatch}</td>
                        <td>${response.temporalGranularity || ''}</td>
                        <td>${response.temporalCoverage || ''}</td>
                        <td>${response.baselineShift || ''}</td>
                        <td>${response.moreData || ''}</td>
                        <td>${response.allVariables || ''}</td>
                        <td>${response.variableRedefined || ''}</td>
                        <td>${response.whatChanged || ''}</td>
                        <td>${response.allParts || ''}</td>
                        <td>${response.thematicAnswer || ''}</td>
                        <td>${response.justification || ''}</td>
                        <td>${response.otherNotes || ''}</td>
                        <td>${response.timestamp}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            document.getElementById('results-table').innerHTML = tableHTML;
            
            showAlert('Survey completed successfully!', 'success');
        }

        // Helper function to properly escape CSV values
        function escapeCsvValue(value) {
            if (value === null || value === undefined) {
                return '""';
            }
            const stringValue = String(value);
            // Escape quotes by doubling them, then wrap in quotes
            return `"${stringValue.replace(/"/g, '""')}"`;
        }

        // Download results as CSV
        function downloadResults() {
            if (responses.length === 0) {
                showAlert('No data to download.', 'warning');
                return;
            }
            
            // Create CSV content
            const headers = ['File_Number', 'File_Name', 'File_Type', 'Response_Set', 'Data_Request', 'Data_Points_Provided', 'Granularity_Match', 'Temporal_Granularity', 'Temporal_Coverage', 'Baseline_Shift', 'More_Data', 'All_Variables', 'Variable_Redefined', 'What_Changed', 'All_Parts', 'Thematic_Answer', 'Justification', 'Other_Notes', 'Timestamp'];
            let csvContent = headers.join(',') + '\n';
            
            responses.forEach(response => {
                const row = [
                    response.imageIndex, // Number, no quotes needed but we'll quote for consistency
                    escapeCsvValue(response.imageName),
                    escapeCsvValue(response.fileType || 'image'),
                    response.iteration, // Number
                    escapeCsvValue(response.dataRequest),
                    escapeCsvValue(response.dataPointsProvided),
                    escapeCsvValue(response.granularityMatch),
                    escapeCsvValue(response.temporalGranularity || ''),
                    escapeCsvValue(response.temporalCoverage || ''),
                    escapeCsvValue(response.baselineShift || ''),
                    escapeCsvValue(response.moreData || ''),
                    escapeCsvValue(response.allVariables || ''),
                    escapeCsvValue(response.variableRedefined || ''),
                    escapeCsvValue(response.whatChanged || ''),
                    escapeCsvValue(response.allParts || ''),
                    escapeCsvValue(response.thematicAnswer || ''),
                    escapeCsvValue(response.justification || ''),
                    escapeCsvValue(response.otherNotes || ''),
                    escapeCsvValue(response.timestamp)
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `survey_results_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Results downloaded successfully!', 'success');
        }

        // Reset survey
        function resetSurvey() {
            if (confirm('Are you sure you want to start a new survey? This will clear all current data.')) {
                // Reset all variables
                imageFiles = [];
                imageDataUrls = [];
                fileTypes = [];
                currentImageIndex = 0;
                currentIteration = 1;
                responses = [];
                surveyStarted = false;
                
                // Reset form
                clearForm();
                document.getElementById('image-files').value = '';
                
                // Show setup section, hide others
                document.getElementById('setup-section').classList.remove('hidden');
                document.getElementById('progress').classList.add('hidden');
                document.getElementById('survey-section').classList.add('hidden');
                document.getElementById('results-section').classList.add('hidden');
                document.getElementById('image-list').classList.add('hidden');
                document.getElementById('start-survey-btn').classList.add('hidden');
                
                // Clear alerts
                document.getElementById('alert-container').innerHTML = '';
                
                showAlert('Survey reset. Please load new files to start.', 'success');
            }
        }

        // Show alert messages
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            alertContainer.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            showAlert('Welcome! Please load your images or PDFs to begin the survey.', 'success');
        });
    </script>
</body>
</html>