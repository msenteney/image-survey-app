<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Survey</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            max-width: 900px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .progress-bar {
            background: #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .image-container { 
            text-align: center; 
            margin: 30px 0; 
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .image-container img { 
            max-width: 100%; 
            max-height: 400px;
            height: auto; 
            border: 3px solid #007bff; 
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .form-section { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 8px; 
            margin: 20px 0; 
            border-left: 5px solid #007bff;
        }
        
        .question-block {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 5px;
        }
        
        .radio-group {
            margin: 10px 0;
        }
        
        .radio-group label {
            margin-left: 8px;
            font-weight: normal;
        }
        
        .buttons { 
            display: flex; 
            gap: 15px; 
            justify-content: center; 
            margin: 30px 0; 
            flex-wrap: wrap;
        }
        
        button { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
            min-width: 150px;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-warning { 
            background: #ffc107; 
            color: #212529;
        }
        
        .btn-primary { 
            background: #007bff; 
            color: white; 
        }
        
        .btn-success { 
            background: #28a745; 
            color: white; 
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .results { 
            margin: 20px 0; 
        }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 20px 0;
        }
        
        th, td { 
            border: 1px solid #ddd; 
            padding: 12px 8px; 
            text-align: left; 
        }
        
        th { 
            background: #007bff; 
            color: white;
            font-weight: bold;
        }
        
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .hidden {
            display: none;
        }
        
        .alert {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .file-input {
            margin: 20px 0;
            padding: 15px;
            background: #e9ecef;
            border-radius: 5px;
        }
        
        input[type="file"] {
            margin: 10px 0;
        }
        
        #image-list {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Image Response Survey</h1>
        
        <!-- Image Upload Section -->
        <div id="setup-section">
            <div class="file-input">
                <h3>üñºÔ∏è Load Your Images</h3>
                <p>Select multiple images from your computer:</p>
                <input type="file" id="image-files" multiple accept="image/*">
                <button class="btn-primary" onclick="loadImages()">Load Images</button>
                
                <div id="image-list" class="hidden">
                    <h4>Loaded Images:</h4>
                    <ul id="loaded-images-list"></ul>
                </div>
                
                <button class="btn-success hidden" id="start-survey-btn" onclick="startSurvey()">Start Survey</button>
            </div>
        </div>
        
        <!-- Progress Bar -->
        <div id="progress" class="progress-bar hidden">
            <span id="progress-text">Image 1 of 0, Response Set 1</span>
        </div>
        
        <!-- Survey Section -->
        <div id="survey-section" class="hidden">
            <div class="image-container">
                <h3 id="image-title">Image 1 - Response Set 1</h3>
                <img id="current-image" src="" alt="Survey Image" onerror="handleImageError()">
            </div>
            
            <div class="form-section">
                <h4>üìù Your Response</h4>
                
                <div class="question-block">
                    <label><strong>Is there a data request in this image?</strong></label><br>
                    <div class="radio-group">
                        <input type="radio" name="data_request" value="Yes" id="yes">
                        <label for="yes">Yes</label>
                    </div>
                    <div class="radio-group">
                        <input type="radio" name="data_request" value="No" id="no">
                        <label for="no">No</label>
                    </div>
                </div>
                
                <div id="data-points-section" class="question-block hidden">
                    <label for="data_points"><strong>How many data points did the government provide?</strong></label><br>
                    <input type="number" id="data_points" min="0" value="0" style="width: 100px; padding: 5px;">
                </div>
                
                <div class="buttons">
                    <button class="btn-warning" onclick="repeatImage()">üîÅ Repeat This Image</button>
                    <button class="btn-primary" onclick="nextImage()">‚û°Ô∏è Next Image</button>
                    <button class="btn-success" onclick="finishSurvey()">‚úÖ Finish Survey</button>
                </div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <h2>üéâ Survey Complete!</h2>
            <p>Thank you for your responses. Total responses collected: <strong id="total-responses">0</strong></p>
            
            <div class="buttons">
                <button class="btn-info" onclick="downloadResults()">üì• Download CSV</button>
                <button class="btn-warning" onclick="resetSurvey()">üîÑ Start New Survey</button>
            </div>
            
            <div id="results-table"></div>
        </div>
        
        <!-- Alert Messages -->
        <div id="alert-container"></div>
    </div>

    <script>
        // Global variables
        let imageFiles = [];
        let imageDataUrls = [];
        let currentImageIndex = 0;
        let currentIteration = 1;
        let responses = [];
        let surveyStarted = false;

        // Load images from file input
        function loadImages() {
            const fileInput = document.getElementById('image-files');
            const files = fileInput.files;
            
            if (files.length === 0) {
                showAlert('Please select at least one image file.', 'warning');
                return;
            }
            
            imageFiles = Array.from(files);
            imageDataUrls = [];
            
            let filesProcessed = 0;
            const imagesList = document.getElementById('loaded-images-list');
            imagesList.innerHTML = '';
            
            // Process each file
            imageFiles.forEach((file, index) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    imageDataUrls[index] = e.target.result;
                    
                    // Add to display list
                    const listItem = document.createElement('li');
                    listItem.textContent = `${index + 1}. ${file.name}`;
                    imagesList.appendChild(listItem);
                    
                    filesProcessed++;
                    
                    // When all files are processed
                    if (filesProcessed === imageFiles.length) {
                        document.getElementById('image-list').classList.remove('hidden');
                        document.getElementById('start-survey-btn').classList.remove('hidden');
                        showAlert(`Successfully loaded ${imageFiles.length} images!`, 'success');
                    }
                };
                
                reader.onerror = function() {
                    showAlert(`Error loading ${file.name}`, 'warning');
                    filesProcessed++;
                };
                
                reader.readAsDataURL(file);
            });
        }

        // Start the survey
        function startSurvey() {
            if (imageDataUrls.length === 0) {
                showAlert('Please load images first.', 'warning');
                return;
            }
            
            surveyStarted = true;
            currentImageIndex = 0;
            currentIteration = 1;
            responses = [];
            
            // Hide setup, show survey
            document.getElementById('setup-section').classList.add('hidden');
            document.getElementById('progress').classList.remove('hidden');
            document.getElementById('survey-section').classList.remove('hidden');
            
            // Setup event listeners
            setupEventListeners();
            
            // Initialize display
            updateDisplay();
            
            showAlert('Survey started! Answer the questions and use the buttons to navigate.', 'success');
        }

        // Setup event listeners
        function setupEventListeners() {
            // Show/hide data points question based on radio selection
            document.querySelectorAll('input[name="data_request"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const dataPointsSection = document.getElementById('data-points-section');
                    if (this.value === 'Yes') {
                        dataPointsSection.classList.remove('hidden');
                    } else {
                        dataPointsSection.classList.add('hidden');
                    }
                });
            });
        }

        // Update display
        function updateDisplay() {
            if (!surveyStarted || imageDataUrls.length === 0) return;
            
            // Update image
            const imageElement = document.getElementById('current-image');
            imageElement.src = imageDataUrls[currentImageIndex];
            
            // Update titles
            document.getElementById('image-title').textContent = 
                `Image ${currentImageIndex + 1} - Response Set ${currentIteration}`;
            
            document.getElementById('progress-text').textContent = 
                `Image ${currentImageIndex + 1} of ${imageDataUrls.length}, Response Set ${currentIteration}, Total Responses: ${responses.length}`;
        }

        // Handle image loading errors
        function handleImageError() {
            showAlert('Error loading current image. Please check the file.', 'warning');
        }

        // Get form data
        function getFormData() {
            const dataRequestRadio = document.querySelector('input[name="data_request"]:checked');
            const dataPointsInput = document.getElementById('data_points');
            
            if (!dataRequestRadio) {
                showAlert('Please answer whether there is a data request.', 'warning');
                return null;
            }
            
            return {
                imageIndex: currentImageIndex + 1,
                imageName: imageFiles[currentImageIndex] ? imageFiles[currentImageIndex].name : `Image_${currentImageIndex + 1}`,
                iteration: currentIteration,
                dataRequest: dataRequestRadio.value,
                dataPoints: dataRequestRadio.value === 'Yes' ? parseInt(dataPointsInput.value) || 0 : null,
                timestamp: new Date().toLocaleString()
            };
        }

        // Clear form
        function clearForm() {
            document.querySelectorAll('input[name="data_request"]').forEach(radio => {
                radio.checked = false;
            });
            document.getElementById('data_points').value = 0;
            document.getElementById('data-points-section').classList.add('hidden');
        }

        // Repeat current image
        function repeatImage() {
            const formData = getFormData();
            if (!formData) return;
            
            responses.push(formData);
            currentIteration++;
            clearForm();
            updateDisplay();
            showAlert('Response saved! You can provide another response for this image.', 'success');
        }

        // Move to next image
        function nextImage() {
            const formData = getFormData();
            if (!formData) return;
            
            responses.push(formData);
            currentImageIndex++;
            currentIteration = 1;
            clearForm();
            
            if (currentImageIndex >= imageDataUrls.length) {
                showResults();
            } else {
                updateDisplay();
                showAlert('Response saved! Moving to next image.', 'success');
            }
        }

        // Finish survey
        function finishSurvey() {
            const formData = getFormData();
            if (formData) {
                responses.push(formData);
            }
            showResults();
        }

        // Show results
        function showResults() {
            document.getElementById('survey-section').classList.add('hidden');
            document.getElementById('progress').classList.add('hidden');
            document.getElementById('results-section').classList.remove('hidden');
            
            document.getElementById('total-responses').textContent = responses.length;
            
            // Create results table
            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th>Image #</th>
                            <th>Image Name</th>
                            <th>Response Set</th>
                            <th>Data Request?</th>
                            <th>Data Points</th>
                            <th>Timestamp</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            responses.forEach(response => {
                tableHTML += `
                    <tr>
                        <td>${response.imageIndex}</td>
                        <td>${response.imageName}</td>
                        <td>${response.iteration}</td>
                        <td>${response.dataRequest}</td>
                        <td>${response.dataPoints !== null ? response.dataPoints : 'N/A'}</td>
                        <td>${response.timestamp}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            document.getElementById('results-table').innerHTML = tableHTML;
            
            showAlert('Survey completed successfully!', 'success');
        }

        // Download results as CSV
        function downloadResults() {
            if (responses.length === 0) {
                showAlert('No data to download.', 'warning');
                return;
            }
            
            // Create CSV content
            const headers = ['Image_Number', 'Image_Name', 'Response_Set', 'Data_Request', 'Data_Points', 'Timestamp'];
            let csvContent = headers.join(',') + '\n';
            
            responses.forEach(response => {
                const row = [
                    response.imageIndex,
                    `"${response.imageName}"`,
                    response.iteration,
                    response.dataRequest,
                    response.dataPoints !== null ? response.dataPoints : '',
                    `"${response.timestamp}"`
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `survey_results_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Results downloaded successfully!', 'success');
        }

        // Reset survey
        function resetSurvey() {
            if (confirm('Are you sure you want to start a new survey? This will clear all current data.')) {
                // Reset all variables
                imageFiles = [];
                imageDataUrls = [];
                currentImageIndex = 0;
                currentIteration = 1;
                responses = [];
                surveyStarted = false;
                
                // Reset form
                clearForm();
                document.getElementById('image-files').value = '';
                
                // Show setup section, hide others
                document.getElementById('setup-section').classList.remove('hidden');
                document.getElementById('progress').classList.add('hidden');
                document.getElementById('survey-section').classList.add('hidden');
                document.getElementById('results-section').classList.add('hidden');
                document.getElementById('image-list').classList.add('hidden');
                document.getElementById('start-survey-btn').classList.add('hidden');
                
                // Clear alerts
                document.getElementById('alert-container').innerHTML = '';
                
                showAlert('Survey reset. Please load new images to start.', 'success');
            }
        }

        // Show alert messages
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            alertContainer.appendChild(alertDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            showAlert('Welcome! Please load your images to begin the survey.', 'success');
        });
    </script>
</body>
</html>